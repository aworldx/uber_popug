# AWESOME TASK MANAGER

### Схемы
Сорян, не успеваю нарисовать, ниже текстовое описание сервисов.
Опыта сервисного прототипирования особо нет, так что сорри, если такой формат неудобен будет.

### Брокер сообщений Kafka
Обмен сообщениями между сервисами.
Топики: Авторизация, Задачи, Аккаунтиг.

### Сервис Авторизации
API для регистрации и авторизации попугов.
Стек: Ruby on Rails

Команды:
 - ДобавитьНовогоПопуга(Имя, Роль, Почта) -> Попуг
 - РаспознатьПопугаПоКлюву(Клюв) -> Токен
 - ПолучитьСписокПопугов() -> СписокПопугов

События:
 - НовыйПопугДобавлен. Метаданные: Имя, Роль, ИдПопуга, Почта. Топики: Авторизация
 - ПопугВлетелВСистему. Метаданные: Попуг. Топики: Авторизация

БД Таблицы:
 - Роли(Ид, Имя)
 - Попуги(Ид, Имя, ИдРоли, Почта)

PS: логику хранения и формирования токенов пока опускаю.
В токене зашита идПопуга и его роль.

### Сервис Task Manager
API для хранения, добавления, назначения задач для попугов.
Стек: Ruby on Rails

Команды:
 - ДобавитьЗадачу(Описание, ИдИсполнителя) -> Задача
 - ЗаассайнитьЗадачи()
 - ПолучитьСписокЗадач() -> МассивЗадач
 - ВыполнитьЗадачу(ИдЗадачи)

PS: подразумевается, что все команды авторизованы,
и в контексте команды содержится токен текущего пользователя.

События:
 - ЗадачаДобавлена. Метаданные: ИдЗадачи, Описание. Топики: Задачи
 - ЗадачаЗаассайнена. Метаданные: ИдЗадачи, ИдПопуга. Топики: Задачи
 - ЗадачаВыполнена. Метаданные: ИдЗадачи, ИдПопуга. Топики: Задачи

БД Таблицы:
 - Попуги(Ид, Имя, Роль) (репликация)
 - Задачи(ИдАвтора, Описание, Статус, ИдИсполнителя)

PS: Историю ассайна для простоты хранить не будем.

### Сервис Accounting
Аккаунтинг. Стек: Ruby on Rails.

Команды:
 - (НовыйПопугДобавлен ->) ДобавитьСчет(ИдПопуга) -> Счет
 - (ЗадачаДобавлена ->) ДобавитьЗадачу(ИдЗадачи, Описание) -> ИдЗадачи (репликация)
 - (ЗадачаДобавлена ->) ОценитьЗадачу(ИдЗадачи) -> СколькоСписать, СколькоНачислить
 - (ЗадачаЗаассайнена ->) СоздатьСчетЕслиНету(ИдПопуга)
 - (ЗадачаЗаассайнена ->) СписатьБабос(ИдЗадачи, ИдПопуга)
 - (ЗадачаВыполнена ->) НачислитьБабос(ИдЗадачи, ИдПопуга)
 - ВыплатитьИлиПеренестиБалансы()
 - ПолучитьАудитЛог(Дата)
 - ПолучитьБаланс()

PS: подразумевается, что команды ПолучитьАудитЛог, ПолучитьБаланс авторизованы,
и в контексте команды содержится токен текущего пользователя.

События:
 - ЗадачаОценена. Метаданные: ИдЗадачи, СколькоНачислить. Топики: Аккаунтинг
 - БабосНачислен. Метаданные: ИдПопуга, Сумма. Топики: Аккаунтинг
 - БабосСписан. Метаданные: ИдПопуга, Сумма. Топики: Аккаунтинг
 - БалансВыплачен. Метаданные: ИдПопуга, Сумма. Топики: Аккаунтинг
 - БалансПеренесенНаСледДень. Метаданные: ИдПопуга, Сумма. Топики: Аккаунтинг
 - ПопугУшелВМинус. Метаданные: ИдПопуга. Топики: Аккаунтинг
 - ПопугЗакрылМинус. Метаданные: ИдПопуга. Топики: Аккаунтинг

БД Таблицы:
- Транзакции (ДатаПлатежа, Тип, Сумма, ИдСчета, ИдЗадачи)
- Счета(ИдПопуга, Баланс)
- Задачи(ИдЗадачи, Описание, СуммаСписания, СуммаНачисления) (репликация)

### Сервис уведомлении
Отправка почты. Стек: Ruby on Rails.

Команды:
 - (НовыйПопугДобавлен ->) ДобавитьПопуга(ИдПопуга, Почта) (репликация)
 - (БалансВыплачен ->) ОтправитьВыплатуНаПочту(ИдПопуга, Сумма)

БД Таблицы:
- Попуги(Ид, Почта) (репликация)

### Сервис Аналитики
Аналитика. Стек Ruby on Rails.
Судя по книгам аналитику можно собирать посредством инструментария Kafka (KSQL) на основе потока событий.

Команды:
- ПолучитьСамуюДорогуюЗадачу(ДатаНачала, ДатаОкончания). Анализ событий: ЗадачаОценена (подумывать как учитывать только закрытые задачи)
- СколькоЗаработалТопМенеджмент(). Анализ событий: БабосНачислен, БабосСписан. Период: Сегодня
- СколькоПопуговУшлоВМинус(). Анализ событий: ПопугУшелВМинус, ПопугЗакрылМинус. Период: Сегодня
- ПолучитьСтатистикуПоДням(ДатаНачала, ДатаОкончания). Анализ событий: БабосНачислен, БабосСписан. Период: за период в разрезе дней.

### Сервис Dashboard
Фронт для авторизации, Task Manager, Accounting.
Стек: React

Вьюхи: Регистрация, Логин, СписокМоихЗадач, ДобавлениеНовойЗадачи, Дашбоард,
Просмотр счета

### Сервис Analytics Dashboard
Фронт для аналитики. Сделал отдельным сервисом, чтобы проще и надежнее разделить доступы.
Стек: React

Вьюхи: Просмотр аналитики.

### Как работает авторизация в сервисах
 - с помощью открытого ключа расшифровывается токен
 - из токена берется идПопуга, роль
 - с помощью policy описанного в самом сервисе проверяется доступ к команде

## Взаимодействие между сервисами
Dashboard -> Сервис Авторизации (sync). Команды: ДобавитьНовогоПопуга, РаспознатьПопугаПоКлюву, ПолучитьСписокПопугов

Dashboard -> Сервис Task Manager (sync). Команды: ДобавитьЗадачу, ЗаассайнитьЗадачи, ПолучитьСписокЗадач, ВыполнитьЗадачу

Dashboard -> Accounting (sync). Команды: ПолучитьАудитЛог, ПолучитьБаланс

Dashboard -> Сервис Аналитики (sync). Команды: СколькоЗаработалТопМенеджмент, ПолучитьСтатистикуПоДням

---

Analytics Dashboard -> Сервис Аналитики (sync). Команды: ПолучитьСамуюДорогуюЗадачу, СколькоЗаработалТопМенеджмент, СколькоПопуговУшлоВМинус

---

Сервис Авторизации -> Сервис Accounting(async). События: НовыйПопугДобавлен

Сервис Авторизации -> Сервис Уведомлений (async). События: НовыйПопугДобавлен

---

Сервис Task Manager -> Сервис Accounting(async). События: ЗадачаДобавлена, ЗадачаЗаассайнена, ЗадачаВыполнена

---

Сервис Accounting -> Сервис Уведомлений (async). События: БалансВыплачен

Сервис Accounting -> Сервис Аналитики (async). События: ЗадачаОценена, ПопугУшелВМинус, ПопугЗакрылМинус, БабосНачислен, БабосСписан

## Спорные места
 - репликация данных (возможно, то что данные повторяются в сервисах может где-то выстрелить в ногу)
 - расчет баланса на основе событий (тут должна быть гарантия доставки сообщения и только один раз,
насколько я слышал гарантировать это очень и очень трудно)
 - идентификаторы попугов хранятся только в сервисе авторизации. При работе с ними в других
сервисах надо либо доверять что с таким ид попуг действительньо существует, либо делать синхронные запросы в сервис авторизации.

## О себе
Имя: Хасанов Амир  
Почта: a.khasanov@talenttech.ru  
Должность: Разработчик (RubyOnRails 3+ года)

